<div id="welcomePage" class="flex-column align-items-center text-center">
    <h1>Bold Smart Lock</h1>
    <p>Welcome to <code>homebridge-bold</code>. This Homebridge plugin provides HomeKit support for the Bold Smart Lock.</p>

    <button onclick="show('phoneNumber')" class="btn btn-primary mt-5">Log in</button>
</div>

<div id="phoneNumberPage" class="flex-column align-items-center text-center">
    <h3>Enter your phone number</h3>
    <input class="form-control mt-3 w-50" id="phoneNumber" name="Phone number" placeholder="Phone number" type="tel" />
    <button onclick="requestCode()" class="btn btn-primary rounded-circle mt-3"><i class="fa fa-arrow-right"></i></button>
</div>

<div id="validationCodePage" class="flex-column align-items-center text-center">
    <h3>Enter the validation code</h3>
    <input class="form-control mt-3 w-50" id="validationCode" name="Validation code" placeholder="Validation code" type="number" />
    <button onclick="validateCode()" class="btn btn-primary rounded-circle mt-3"><i class="fa fa-arrow-right"></i></button>
</div>

<div id="passwordPage" class="flex-column align-items-center text-center">
    <h3>Enter your password</h3>
    <input class="form-control mt-3 w-50" id="password" name="Password" placeholder="Password" type="password" />
    <button onclick="authenticate()" class="btn btn-primary rounded-circle mt-3"><i class="fa fa-arrow-right"></i></button>
</div>

<div id="configPage">This Homebridge plugin provides HomeKit support for the Bold Smart Lock.</div>
<div id="error" class="text-center text-danger"></div>

<script>
    let welcomePage = document.getElementById('welcomePage');
    let phoneNumberPage = document.getElementById('phoneNumberPage');
    let validationCodePage = document.getElementById('validationCodePage');
    let passwordPage = document.getElementById('passwordPage');
    let configPage = document.getElementById('configPage');

    let phoneNumber, validationId;

    (async () => {
        let config = await homebridge.getPluginConfig();
        
        if (!config || !config.length) {
            show('welcome')
        } else {
            show('config');
        }
    })();

    function show(page) {
        welcomePage.style.display = 'none';
        phoneNumberPage.style.display = 'none';
        validationCodePage.style.display = 'none';
        passwordPage.style.display = 'none';
        configPage.style.display = 'none';
        homebridge.hideSchemaForm();

        if (page == 'config') {
            configPage.style.display = 'block';
            homebridge.showSchemaForm();
        } else if (page == 'welcome') {
            welcomePage.style.display = 'flex';
        } else if (page == 'phoneNumber') {
            phoneNumberPage.style.display = 'flex';
        } else if (page == 'validationCode') {
            validationCodePage.style.display = 'flex';
        } else if (page == 'password') {
            passwordPage.style.display = 'flex';
        }
    }

    async function requestCode() {
        phoneNumber = document.getElementById('phoneNumber').value;

        try {
            let response = await homebridge.request('/requestCode', { phoneNumber });

            validationId = response.validationId;

            show('validationCode')
        } catch (error) {
            showError(error);
        }
    }

    async function validateCode() {
        let code = document.getElementById('validationCode').value;

        try {
            let response = await homebridge.request('/validateCode', { validationId, code });

            validationId = response.validationId;

            show('password')
        } catch (error) {
            showError(error);
        }
    }

    async function authenticate() {
        let password = document.getElementById('password').value;

        try {
            let response = await homebridge.request('/authenticate', { validationId, phoneNumber, password });

            let config = await homebridge.getPluginConfig();
            
            if (!config || config.length == 0) {
                config = [{
                    platform: 'Bold'
                }]
            }

            config[0].authToken = response.token;
            
            await homebridge.updatePluginConfig(config);

            show('config')
        } catch (error) {
            showError(error);
        }
    }

    function showError(error) {
        show();

        let errorElement = document.getElementById('error');

        errorElement.innerHTML = JSON.stringify(error);
    }
</script>